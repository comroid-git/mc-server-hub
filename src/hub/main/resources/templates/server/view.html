<!DOCTYPE html>
<!--suppress HtmlFormInputWithoutLabel -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/head}"></head>
<script th:src="@{/static/modules.js}" type="text/javascript"></script>
<script th:src="@{/static/common.js}" type="text/javascript"></script>
<body>
<div class="ui-content">
    <div class="ui-menubar" th:insert="~{/menubar}"></div>
    <form action="/api/webapp/server/edit" method="post">
        <h2>Server <b th:text="${target.getBestName()}"></b>
            - <a class="ui-button" th:href="@{'/server/edit/'+${id}}">Edit</a>
            - <a class="ui-button" th:href="@{'/server/permissions/'+${target.id}+'/'+${user.id}}">Edit
                Permissions</a></h2>
        <h3>General</h3>
        <table>
            <tbody>
            <tr>
                <td class="onequarter">Name</td>
                <td colspan="2"><input name="name" th:readonly="${!edit}" th:value="${target.name}" type="text"></td>
            </tr>
            <tr>
                <td>Displayname</td>
                <td colspan="2"><input name="displayName" th:readonly="${!edit}" th:value="${target.displayName}"
                                       type="text">
                </td>
            </tr>
            <tr>
                <td>Owner</td>
                <td colspan="2"><input name="owner" th:readonly="${!edit}"
                                       th:value="${edit?target.owner.id:target.owner.bestName}"
                                       type="text"></td>
            </tr>
            <tr>
                <td>ID</td>
                <td colspan="2"><input name="id" readonly th:value="${target.id}" type="text"></td>
            </tr>
            <tr>
                <td>Minecraft Version</td>
                <td colspan="2"><input name="mcVersion" th:readonly="${!edit}" th:value="${target.mcVersion}"
                                       type="text"></td>
            </tr>
            <tr>
                <td>Loader</td>
                <td colspan="2"><input name="loader" readonly
                                       th:value="${target.forceCustomJar} ? 'Custom JAR' : ${target.loaderName}"
                                       type="text"></td>
            </tr>
            <tr>
                <td>Runscript</td>
                <td colspan="2">
                    <input name="customCommand" th:if="${edit || target.customCommand != null}" th:readonly="${!edit}" th:value="${target.customCommand}" type="text">
                    <span class="null-text" th:if="${!edit && target.customCommand == null}">Starting via MCSD Agent</span>
                </td>
            </tr>
            <tr>
                <td>Host</td>
                <td><input name="host" th:readonly="${!edit}" th:value="${target.host}"
                           type="text"></td>
                <td><input max="65535" min="1" name="port" th:readonly="${!edit}" th:value="${target.port}"
                           type="number"></td>
            </tr>
            <tr>
                <td>Homepage</td>
                <td colspan="2">
                    <a th:unless="${edit}" th:href="${target.homepage}" th:text="${target.homepage}"></a>
                    <input name="homepage" th:if="${edit}" th:value="${target.homepage}" type="url">
                </td>
            </tr>
            </tbody>
        </table>
        <h3>Advanced configuration</h3>
        <table>
            <tbody>
            <tr>
                <td class="onequarter">Managed</td>
                <td><input name="managed" th:readonly="${!edit}" th:value="${target.managed}" type="checkbox"></td>
            </tr>
            <tr>
                <td>Autostart</td>
                <td><input name="enabled" th:readonly="${!edit}" th:value="${target.enabled}" type="checkbox"></td>
            </tr>
            <tr>
                <td>Whitelist</td>
                <td><input name="whitelist" th:readonly="${!edit}" th:value="${target.whitelist}" type="checkbox">
                </td>
            </tr>
            <tr>
                <td>Query Port</td>
                <td><input max="65535" min="1" name="queryPort" th:readonly="${!edit}"
                           th:value="${target.queryPort}"
                           type="number"></td>
            </tr>
            </tbody>
        </table>
        <input name="auth_key" th:if="${editKey!=null}" th:value="${editKey}" type="hidden">
        <input th:if="${edit}" type="submit" value="Apply">
    </form>
    <h3>Modules</h3>
    <table>
        <thead>
        <tr th:with="canManageModules = ${target.hasPermission(user,T(org.comroid.mcsd.core.entity.AbstractEntity$Permission).ManageModules)}">
            <th th:if="${canManageModules}">
                <button class="ui-button" id="btn-module-add"
                        onclick="$('#dialog-module-add').slideToggle(500, ()=>{})">Add
                </button>
                <div class="ui-blur" id="dialog-module-add">
                    <div class="ui-dialog">
                        <form class="dialog-form" method="post" th:action="@{'/module/add/'+${target.id}}">
                            <select id="module-selector" multiple name="dtype">
                                <option th:each="option: ${target.getFreeModuleTypes()}" th:text="${option.name}"
                                        th:value="${option.name}"></option>
                            </select>
                            <input name="userId" th:value="${user.id}" type="hidden">
                            <input id="btn-module-add-submit" type="submit" value="Apply">
                        </form>
                        <button class="icon-close" onclick="$('#dialog-module-add').slideToggle(500, ()=>{})">X</button>
                    </div>
                </div>
            </th>
            <th th:unless="${canManageModules}"></th>
            <th>Name</th>
            <th>Description</th>
            <th>
                <!-- todo: both of these cause NS_BINDING_ABORTED errors for some reason
                <button onclick="reload(false)">Refresh Config</button>
                <button onclick="confirmAction('do a full reload', 'This will restart the server', ()=>reload(true))">Full Reload</button>
                -->
            </th>
        </tr>
        </thead>
        <tbody>
        <th:block th:each="module: ${modules}">
            <tr class="ui-table-parent" onclick="toggleExpansion" th:id="'module_'+${module.id}">
                <td class="module-state-switch-col"><input class="state-switch" th:checked="${module.enabled}"
                                                           th:id="'state_'+${module.id}"
                                                           type="checkbox"></td>
                <td class="module-name-col" th:text="${module.dtype.name}"></td>
                <td class="module-desc-col" th:text="${module.dtype.description}"></td>
                <td class="module-ctrl-col">
                    <!-- <a class="ui-button" th:href="@{'/module/edit/'+${module.id}}">Edit</a> -->
                    <a class="ui-button" th:href="@{'/module/delete/'+${module.id}}">Delete</a>
                </td>
            </tr>
            <tr class="ui-table-child" th:id="'detail_'+${module.id}">
                <td colspan="4">
                    <form>
                        <table>
                            <thead>
                            <tr>
                                <th class="module-prop-name-col"></th>
                                <th class="module-prop-value-col"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="e: ${module.dtype.proto.properties}" th:with="prop = ${e.value}">
                                <td th:text="${prop.alternateName}"></td>
                                <td><input th:value="${prop.getter.invokeSilent(module)}" type="text"></td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </td>
            </tr>
        </th:block>
        </tbody>
    </table>
</div>
<div class="ui-footer" th:insert="~{/footer}"></div>
</body>
</html>